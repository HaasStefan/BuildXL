trigger: none

pool:
  name: BuildXL-DevOpsAgents-PME

resources:
  repositories:
    - repository: DominoReleaseManagement
      type: git
      name: Domino.ReleaseManagement
    - repository: CloudBuild
      type: git
      name: CloudBuild

stages:
- stage:
  jobs:
    - job: UpdateSBOMPackages
      displayName: "Update SBOM Packages"
      steps:
      - checkout: self
        persistCredentials: true
      - checkout: DominoReleaseManagement
      - checkout: CloudBuild
      - template: /.azdo/common/use-latest-dotnet-sdk.yml

      # Nuget authenticate is required for package restore to work even though the feed is under the same organization as the pipeline
      - task: NuGetAuthenticate@1
      - task: DotNetCoreCLI@2
        inputs:
          command: 'publish'
          publishWebProjects: false
          projects: '$(Build.SourcesDirectory)/Domino.ReleaseManagement/src/BuildXLReleaseManagement/BuildXLReleaseManagement/BuildXLReleaseManagement.csproj'
          arguments: '--configuration Release --output $(Build.ArtifactStagingDirectory)'
          zipAfterPublish: false
      - template: /.azdo/common/journaling.yml # Enable journaling

      # Generate access tokens
      - template: /.azdo/common/generate-access-token.yml
        parameters:
          ServiceConnection: 'mseng-Domino-BuildXL-Pipelines'
          Resource: 'https://cloudbuild.microsoft.com/'
          AccessTokenVariable: CloudBuildAccessToken
      - template: /.azdo/common/set-variable-pats.yml
        parameters:
          workingDirectory: $(Build.SourcesDirectory)/BuildXL.Internal
          buildXLSourceDirectory: $(Build.SourcesDirectory)/BuildXL.Internal
      - template: /.azdo/common/generate-access-token.yml
        parameters:
          AccessTokenVariable: BuildXL-Pipeline-AccessToken

      - task: PowerShell@2
        inputs:
          targetType: 'inline'
          script: .\BuildXLReleaseManagement.exe updatePackages --Packages Microsoft.SBOMCore@latest@1essharedassets@Packaging@$(BuildXL-Pipeline-AccessToken) Microsoft.Parsers.ManifestGenerator@latest@1essharedassets@Packaging@$(BuildXL-Pipeline-AccessToken) Microsoft.Sbom.Parsers.Spdx22SbomParser@latest@nuget.org Microsoft.SBOM.Adapters@latest@nuget.org Microsoft.ManifestInterface@latest@1essharedassets@Packaging@$(BuildXL-Pipeline-AccessToken) Microsoft.Sbom.Contracts@latest@nuget.org Microsoft.ComponentDetection.Contracts@latest@nuget.org python@latest@nuget.org Microsoft.VisualStudio.Services.Governance.ComponentDetection@latest@mseng@ComponentGovernance@$(BuildXL-Pipeline-AccessToken) Microsoft.Sbom.Extensions@latest@nuget.org --OneEsToken $(BuildXL-Pipeline-AccessToken) --CbToken $(BuildXL-Pipeline-AccessToken) --MsEngGitToken $(BuildXL-Pipeline-AccessToken) --cloudBuildAuthenticationToken $(CloudBuildAccessToken) --BuildXLSourceRoot "$(Build.SourcesDirectory)/BuildXL.Internal" --CloudbuildSourceRoot "$(Build.SourcesDirectory)/CloudBuild"
          showWarnings: true
          pwsh: false
          workingDirectory: '$(Build.ArtifactStagingDirectory)/BuildXLReleaseManagement'

      # Copy and publish BuildXL log in case it failed during the schedule phase
      - task: CopyFiles@2
        continueOnError: true
        inputs:
          SourceFolder: '$(Build.SourcesDirectory)/BuildXL.Internal/Out/Logs'
          Contents: '**/BuildXL.log'
          TargetFolder: '$(Build.ArtifactStagingDirectory)/BuildXLLogs'
      - task: PublishPipelineArtifact@1
        continueOnError: true
        inputs:
          targetPath: '$(Build.ArtifactStagingDirectory)/BuildXLLogs'
          artifact: '$(Build.BuildId).Logs'
          publishLocation: 'pipeline'

    - job: UpdateNoticeFile
      displayName: "Update NOTICE.txt in BuildXL.Internal"
      steps:
      - checkout: self
        fetchDepth: 1
        persistCredentials: true
      
      # Run component detection to generate NOTICE file in the root of the repo.
      # The generated file will be included in the nuget packages we create and publish in this job 
      # If any of these tasks fail we fall back the the NOTICE.txt already checked in the repository.
      - task: ComponentGovernanceComponentDetection@0
        displayName: Component Detection

      - task: notice@0
        displayName: Generate NOTICE file
        inputs:
          outputfile: $(Build.SourcesDirectory)\BuildXL.Internal\NOTICE.txt
          outputformat: text

      - checkout: DominoReleaseManagement
      - template: /.azdo/common/use-latest-dotnet-sdk.yml

      # Nuget authenticate is required for package restore to work even though the feed is under the same organization as the pipeline
      - task: NuGetAuthenticate@1
      - task: DotNetCoreCLI@2
        inputs:
          command: 'publish'
          publishWebProjects: false
          projects: '$(Build.SourcesDirectory)/Domino.ReleaseManagement/src/BuildXLReleaseManagement/BuildXLReleaseManagement/BuildXLReleaseManagement.csproj'
          arguments: '--configuration Release --output $(Build.ArtifactStagingDirectory)'
          zipAfterPublish: false

      # Generate Access Token
      - template: /.azdo/common/generate-access-token.yml
        parameters:
          AccessTokenVariable: BuildXL-Pipeline-AccessToken

      - task: PowerShell@2
        inputs:
          targetType: 'inline'
          script: .\BuildXLReleaseManagement.exe updateNoticeFile --MsEngGitToken $(BuildXL-Pipeline-AccessToken) --BuildXLSourceRoot "$(Build.SourcesDirectory)/BuildXL.Internal"
          showWarnings: true
          pwsh: false
          workingDirectory: '$(Build.ArtifactStagingDirectory)/BuildXLReleaseManagement'